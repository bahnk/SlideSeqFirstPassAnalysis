{%- block proportions -%}
st_adata.obsm["proportions"] = st_model.get_proportions()
	
for cell_type in st_adata.obsm["proportions"].columns:
	data = st_adata.obsm["proportions"][cell_type].values
	st_adata.obs[cell_type] = np.clip(data, 0, np.quantile(data, 0.99))

st_adata.obs["CellType"] = st_adata.obsm["proportions"].idxmax(axis=1)

save_anndata(st_adata, h5dir, "05", f"proportions.{{ name }}")
{%- endblock -%}
