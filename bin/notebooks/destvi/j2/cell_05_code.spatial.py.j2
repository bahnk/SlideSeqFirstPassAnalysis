{%- block spatial -%}
st_adata = sc.read_10x_mtx("{{ dge }}")

# add spatial information
spatial = pd\
	.read_csv("{{ puck }}")\
	.rename(columns={"PuckBarcode": "Barcode"})\
	.set_index("SeqBarcode")
st_adata.obs = spatial.loc[ st_adata.obs.index ]

# remove undetected genes
st_adata = st_adata[ : , ~ np.all(st_adata.X.toarray() == 0, axis=0) ]

# otherwise names can't match with reference
st_adata.var_names = st_adata.var_names.str.upper()

sc.pp.normalize_total(st_adata, target_sum=10e4)
sc.pp.log1p(st_adata)
st_adata.raw = st_adata
{%- endblock -%}
